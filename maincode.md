# main code
- Please make sure to enter your own dbid in allowedDbIds. The ID already entered is Kentaki's ID.
- If you use the command without authorization, the dbid will be displayed in all lowercase along with a message. Add the displayed id to allowedDbIds
  Be sure to enter it in lowercase as it will be converted to lowercase for comparison!!
- Only the minimum callbacks are defined in registeredCallbacks.
Please add them according to https://github.com/kentaki65/bloxd-code-loader#definitions-controlling-callback-behavior

  (The same goes for callbackDefinitions)
```js
const allowedDbIds=["5hfyzhrl29vwqhxyvaahe"];
const beDisplay=false;
const chestPosition=[0,0,0];
const registeredCallbacks={ tick : []};
const callbackDefinitions={ tick : {returns: false}};
require={};
let p="setStandardChest";p+="ItemSlot";
const setslot=api[p];let e="getStandardChest";e+="Items";const getslot=api[e];let i="getStandardChest";i+="ItemSlot";const itemget=api[i];let USE_UNICODE_ENCODING=!1,_escapeInput="",_escapedResult="",_escapeIndex=0,_escapePlayerId=null,_escapePos=null,_escapeMeta=null;for(const eventName in loadedCodes={},codeNameMap={},registeredAutoCodes={},alreadyLogged={},tickCount=0,registeredTicks=[],CHEST_POSITIONS=[],_writeChunks=[],_writePos=null,_writePlayerId=null,_writeIndex=0,_writeMetadata=null,callbackDefinitions){let e=callbackDefinitions[eventName];!1===e.returns?globalThis[eventName]=(...t)=>{if(Array.isArray(registeredCallbacks[eventName]))for(let a of registeredCallbacks[eventName])try{a(...t)}catch(s){beDisplay&&api.log(`${eventName} error from ${a._codeName||"unknown"}: ${s}`)}}:globalThis[eventName]=(...t)=>{if(Array.isArray(registeredCallbacks[eventName]))for(let a of registeredCallbacks[eventName])try{let s=a(...t);if(e.returns.includes(s)||e.returns.includes(typeof s))return s}catch(o){api.log(`${eventName} error from ${a._codeName||"unknown"}: ${o}`)}return!!e.returns.includes(!0)||void 0}}
function tick(){let t=api.getBlock(chestPosition);if(20===tickCount&&beDisplay&&api.log("Start loading..."),40===tickCount&&("Chest"===t?(loadChestPositionsFromChest(chestPosition),loadCodeMetadata(),loadAllAutoCodes()):beDisplay&&api.log(`Chest not found (${t})`)),"object"==typeof registeredCallbacks&&Array.isArray(registeredCallbacks.tick))for(let a of registeredCallbacks.tick)try{let s=a._codeName||"NO_NAME";alreadyLogged[s]||(beDisplay&&api.log("Running: "+s),alreadyLogged[s]=!0),a()}catch(o){}try{writeCodeTick()}catch(r){api.log(`write error: ${r.message}`)}tickCount++}
function playerCommand(t,a){let s=!1;if(Array.isArray(registeredCallbacks.playerCommand))for(let o of registeredCallbacks.playerCommand)try{!0===o(t,a)&&(s=!0)}catch(r){}let l=a.trim().split(/\s+/),n=l[0].replace("/",""),d=l.slice(1);if("loadcode"===n){if(!isAuthorized(t))return api.sendMessage(t,"Not on the allow list!"+api.getPlayerDbId(t).toLowerCase()),!0;if(1===d.length){let c=d[0],u=codeNameMap[c];if(!u||!Array.isArray(u.SaveDestination))return api.sendMessage(t,`not found or invalid format for: '${c}'`),!0;try{loadCodeFromChests(u.SaveDestination,c),loadedCodes[c]=!0,api.sendMessage(t,`Reloaded '${c}'`)}catch(g){api.sendMessage(t,`Failed to reload '${c}': ${g.message}`)}return!0}return api.sendMessage(t,"How to use: /loadcode <codeName>"),!0}if("unload"===n){if(!isAuthorized(t))return api.sendMessage(t,"Not on the allow list!"+api.getPlayerDbId(t).toLowerCase()),!0;if(1!==d.length)return api.sendMessage(t,"How to use: /unload <codeName>"),!0;let f=d[0];return loadedCodes[f]?(unloadCode(f),delete loadedCodes[f],api.sendMessage(t,`Unloaded: '${f}'`),!0):(api.sendMessage(t,`Not loaded: '${f}'`),!0)}if("reloadauto"===n)return isAuthorized(t)?(loadAllAutoCodes(),api.sendMessage(t,"All auto codes reloaded."),!0):(api.sendMessage(t,"Not on the allow list!"+api.getPlayerDbId(t).toLowerCase()),!0);if("loadedcodes"===n){let y=Object.entries(codeNameMap);if(0===y.length)api.sendMessage(t,"No codes are currently loaded.");else for(let[C,m]of y){let h=m.codeType||"undefined",b=m.creator||"unknown",k=loadedCodes[C]?"✅":"❌";api.sendMessage(t,`[${k}] ${C} | type: ${h} | by: ${b}`)}return!0}if("removecode"===n){if(!isAuthorized(t))return api.sendMessage(t,"Not on the allow list!"+api.getPlayerDbId(t).toLowerCase()),!0;let $=d[0],D=codeNameMap[$];if(api.log($+"\n"+JSON.stringify(D)),!D)return api.sendMessage(t,`The code '${$}' does not exist`),!0;let P=D.SaveDestination;if(!Array.isArray(P))return api.sendMessage(t,`'${$}' No chest associated with was found`),!0;for(let v of P)for(let S=0;S<=35;S++)setslot(v,S,"Air",0,t,{});return delete codeNameMap[$],delete loadedCodes[$],api.sendMessage(t,`'${$}' has been completely removed`),!0}if(s)return!0}
function escapeCodeSync(t){return t.split("").map(t=>"\\u"+t.charCodeAt(0).toString(16).padStart(4,"0")).join("")}
function writeCodeToChest(t,a,s,o,r=!0){try{if("Chest"!==api.getBlock(t)&&api.setBlock(t,"Chest"),r&&"data"!==s.codeType)startEscapeCodeInChunks(a,o,t,s);else{_writeChunks=[];for(let l=0;l<Math.ceil(a.length/390);l++)_writeChunks.push(a.slice(390*l,(l+1)*390));_writePos=t,_writePlayerId=o,_writeIndex=0,_writeMetadata=s,registeredCallbacks.tick.includes(writeCodeTick)||registeredCallbacks.tick.push(writeCodeTick)}try{let n=chestPosition;"Chest"!==api.getBlock(n)&&api.setBlock(n,"Chest");let d=itemget(n,35),c={SaveDestination:[]};if(d?.attributes?.customAttributes?.metadata)try{c=JSON.parse(d.attributes.customAttributes.metadata)}catch{}Array.isArray(c.SaveDestination)||(c.SaveDestination=[]),c.SaveDestination.some(a=>JSON.stringify(a)===JSON.stringify(t))||c.SaveDestination.push(t),setslot(n,35,"Book",1,o,{customDisplayName:"metadata",customAttributes:{metadata:JSON.stringify(c)}})}catch(u){api.log("❌ SaveDestination registration failure: "+u.message)}s.codeName&&Array.isArray(s.SaveDestination)&&(codeNameMap[s.codeName]={SaveDestination:s.SaveDestination,creator:s.Creator||"unknown",codeType:s.codeType||"",checksum:s.checksum})}catch(g){api.log("❌ writeCodeToChest Error: "+g.message)}}
function writeCodeTick(){try{if(!_writePos)return;let t=[..._writePos];for(;_writeIndex<_writeChunks.length;){"Chest"!==api.getBlock(t)&&api.setBlock(t,"Chest");let a=_writeChunks.length-_writeIndex,s=Math.min(34,a);for(let o=0;o<s;o++)setslot(t,o,"Code Block",1,_writePlayerId,{customAttributes:{[`code${_writeIndex}`]:_writeChunks[_writeIndex]}}),api.log(`Writing slot: ${_writeIndex} pos: ${t}`),_writeIndex++;let r=JSON.parse(JSON.stringify(_writeMetadata));if(Array.isArray(r.dependencies)||(r.dependencies=[]),r.nextPos=_writeIndex<_writeChunks.length?[t[0],t[1]+1,t[2]]:null,setslot(t,35,"Book",1,_writePlayerId,{customAttributes:{metadata:JSON.stringify(r)}}),_writeIndex>=_writeChunks.length){api.broadcastMessage(`✅ Code saved successfully! Characters: ${_writeChunks.join("").length}`),_writeChunks=[],_writePos=null,_writePlayerId=null,_writeIndex=0,_writeMetadata=null,registeredCallbacks.tick=registeredCallbacks.tick||[];let l=registeredCallbacks.tick.indexOf(writeCodeTick);l>=0&&registeredCallbacks.tick.splice(l,1);return}t=[t[0],t[1]+1,t[2]]}}catch(n){api.log("❌ writeCodeTick Error: "+n.message)}}
function escapeCodeTick(){try{if("string"!=typeof _escapeInput||!_escapeInput.length)return;let t=Math.min(_escapeIndex+50,_escapeInput.length),a=_escapeInput.slice(_escapeIndex,t);if(_escapedResult+=a.split("").map(t=>"\\u"+t.charCodeAt(0).toString(16).padStart(4,"0")).join(""),(_escapeIndex=t)>=_escapeInput.length){api.log("Escape complete, start writing"),_writeChunks=[];for(let s=0;s<Math.ceil(_escapedResult.length/300);s++)_writeChunks.push(_escapedResult.slice(300*s,(s+1)*300));_writePos=_escapePos,_writePlayerId=_escapePlayerId,_writeIndex=0,_writeMetadata=_escapeMeta,registeredCallbacks.tick.includes(writeCodeTick)||registeredCallbacks.tick.push(writeCodeTick),_escapeInput="",_escapedResult="",_escapeIndex=0,_escapePlayerId=null,_escapePos=null,_escapeMeta=null;let o=registeredCallbacks.tick.indexOf(escapeCodeTick);o>=0&&registeredCallbacks.tick.splice(o,1)}}catch(r){api.log("escapeCodeTick Error: "+r.message)}}
function startEscapeCodeInChunks(t,a,s,o){try{_escapeInput=t,_escapedResult="",_escapeIndex=0,_escapePlayerId=a,_escapePos=s,_escapeMeta=o,registeredCallbacks.tick||(registeredCallbacks.tick=[]),registeredCallbacks.tick.includes(escapeCodeTick)||registeredCallbacks.tick.push(escapeCodeTick)}catch(r){api.log("startEscape Error: "+r.message)}}
function loadAutoWithDependencies(t){let a=codeNameMap[t];if(!a||!Array.isArray(a.SaveDestination)||"auto"!==a.codeType){beDisplay&&api.log(`'${t}' information is invalid or not an auto code`);return}let s=Array.isArray(a.dependencies)?a.dependencies:[];for(let o of s){let r=codeNameMap[o];if(!r||!Array.isArray(r.SaveDestination)){beDisplay&&api.log(`'${o}' does not exist`);return}!loadedCodes[o]&&(loadCodeFromChests(r.SaveDestination,o),loadedCodes[o]=!0,beDisplay&&api.log(`Loaded: '${o}'`))}loadCodeFromChests(a.SaveDestination,t),registeredAutoCodes[t]=!0,beDisplay&&api.log(`Loaded: '${t}'`)}
function registerCallbacks(t,a){for(let s in a){let o=a[s];o._codeName=t,registeredCallbacks[s]||(registeredCallbacks[s]=[]),registeredCallbacks[s]=registeredCallbacks[s].filter(a=>a._codeName!==t),registeredCallbacks[s].push(o)}}
function unloadCode(t){if(loadedCodes[t]){for(let a in registeredCallbacks)registeredCallbacks[a]=registeredCallbacks[a].filter(a=>a._codeName!==t);delete loadedCodes[t],api.log("Unloaded: "+t)}}
function unescapeCode(t){return t.replace(/\\u([\dA-Fa-f]{4})/g,(t,a)=>String.fromCharCode(parseInt(a,16)))}
function isAuthorized(t){let a=api.getPlayerDbId(t).toLowerCase();return allowedDbIds.includes(a)}
function loadCodeFromChests(chestPositions,codeName){let joined="";for(let chestPos of chestPositions){if(!Array.isArray(chestPos)||3!==chestPos.length)continue;let items=getslot(chestPos),codeChunks=[];for(let i=0;i<35;i++){let attr=items[i]?.attributes?.customAttributes;attr?.[`code${i}`]&&(codeChunks[i]=attr[`code${i}`])}joined+=codeChunks.filter(Boolean).join("")}let meta=codeNameMap[codeName];if(!meta){beDisplay&&api.log(`Loading stopped due to unregistered metadata: ${codeName}`);return}try{let unescaped=unescapeCode(joined);if("data"===meta.codeType)require[codeName]=JSON.parse(unescaped),beDisplay&&api.log(`dataCode ${codeName} Loading complete`);else{let exports={},module={exports};eval(unescaped),require[codeName]=module.exports,beDisplay&&api.log(`code ${codeName} Loading complete`)}loadedCodes[codeName]={chestPositions,loadedSuccessfully:!0};let onJoinList=registeredCallbacks?.onPlayerJoin;if(Array.isArray(onJoinList)){let cb=onJoinList.find(e=>e._codeName===codeName);if(cb){let players=api.getPlayerIds()||[];for(let playerId of players)try{cb(playerId)}catch(e){beDisplay&&api.log(`onPlayerJoin(${playerId}) error from ${codeName}: ${e.message}`)}}}}catch(err){!err.message.includes("value has no property")&&beDisplay&&api.log("Eval/Data Load Error: "+err.message),loadedCodes[codeName]={chestPositions,loadedSuccessfully:!1,errorMessage:err.message},err.message.includes("interrupted")&&retryFailedCodeLoads()}}function retryFailedCodeLoads(){for(let[t,a]of Object.entries(loadedCodes))!a.loadedSuccessfully&&Array.isArray(a.chestPositions)&&(beDisplay&&api.log(`Retrying load for: ${t}`),loadCodeFromChests(a.chestPositions,t))}
function loadChestPositionsFromChest(t){try{let a=itemget(t,35);if(a?.attributes?.customAttributes?.metadata){let s=JSON.parse(a.attributes.customAttributes.metadata);Array.isArray(s.SaveDestination)?(CHEST_POSITIONS=s.SaveDestination,beDisplay&&api.log(`Read CHEST_POSITIONS: ${CHEST_POSITIONS.map(t=>`[${t}]`).join(", ")}`)):beDisplay&&api.log("SaveDestination is not an array")}else beDisplay&&api.log("Metadata does not exist")}catch(o){beDisplay&&api.log(`Error loading CHEST_POSITIONS: ${o.message}`)}}
function loadCodeMetadata(){for(let t of(codeNameMap={},CHEST_POSITIONS)){if("Chest"!==api.getBlock(t))continue;let a=getslot(t)?.[35]?.attributes?.customAttributes?.metadata;if("string"==typeof a&&a.trim())try{let s=JSON.parse(a);s.codeName&&Array.isArray(s.SaveDestination)&&(codeNameMap[s.codeName]={SaveDestination:s.SaveDestination,creator:s.Creator||"unknown",codeType:s.codeType||""})}catch(o){api.log(`Meta loading failure: ${o.message}`)}else api.log(`Metadata not found: ${JSON.stringify(t)}`)}}
function loadAllAutoCodes(){let t=[],a=[];for(let s of CHEST_POSITIONS){let o=getslot(s);if(!Array.isArray(o))continue;let r="";for(let l=0;l<35;l++){let n=o[l]?.attributes?.customAttributes?.[`code${l}`];n&&(r+=n)}let d=o[35]?.attributes?.customAttributes?.metadata;if("string"!=typeof d||!d.trim())continue;let c;try{c=JSON.parse(d)}catch{beDisplay&&api.log(`Metadata JSON parsing failure @ ${JSON.stringify(s)}`);continue}!c.codeName||("data"===c.codeType?loadedCodes[c.codeName]||t.push({pos:s,rawStr:r,meta:c}):"auto"!==c.codeType||registeredAutoCodes[c.codeName]||a.push(c.codeName))}let u=!1;for(let{pos:g,rawStr:f,meta:y}of t)try{let C=unescapeCode(f);require[y.codeName]=JSON.parse(C),loadedCodes[y.codeName]={chestPositions:[g],loadedSuccessfully:!0},beDisplay&&api.log(`dataCode ${y.codeName} Loading successful`)}catch(m){loadedCodes[y.codeName]={chestPositions:[g],loadedSuccessfully:!1},beDisplay&&api.log(`[dataLoadErr] ${y.codeName} : ${m.message}`),m.message.includes("interrupted")&&(u=!0)}for(let h of a)loadAutoWithDependencies(h);retryFailedCodeLoads(),u&&(api.log("Interrupted error detected, retrying failed loads..."),retryFailedCodeLoads())}readDataCode=t=>require[t]||null,accessDataCode=(t,a="")=>{let s=require[t];if(!s)return api.log(`Data code '${t}' is not loaded`),null;if(!a)return s;try{return a.split(/\.|\[|\]/).filter(Boolean).reduce((t,a)=>t?t[a]:void 0,s)??null}catch{return null}};
```
